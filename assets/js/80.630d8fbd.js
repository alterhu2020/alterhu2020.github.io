(window.webpackJsonp=window.webpackJsonp||[]).push([[80],{336:function(s,e,t){"use strict";t.r(e);var a=t(9),n=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("ClientOnly",[t("in-article-adsense",{attrs:{"ins-style":"display:block; text-align:center;","data-ad-slot":"7727965566"}})],1),s._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#安装命令"}},[s._v("安装命令")])]),t("li",[t("a",{attrs:{href:"#mysqld-cnf配置参数"}},[s._v("mysqld.cnf配置参数")])]),t("li",[t("a",{attrs:{href:"#配置mysql的用户和密码"}},[s._v("配置mysql的用户和密码")])]),t("li",[t("a",{attrs:{href:"#添加数据库和用户-包括修改用户密码"}},[s._v("添加数据库和用户(包括修改用户密码)")])]),t("li",[t("a",{attrs:{href:"#mysql8数据表大小写敏感（可选-上面第二步已经设置）"}},[s._v("mysql8数据表大小写敏感（可选,上面第二步已经设置）")])]),t("li",[t("a",{attrs:{href:"#读写分离配置"}},[s._v("读写分离配置")]),t("ul",[t("li",[t("a",{attrs:{href:"#读写分离报错问题"}},[s._v("读写分离报错问题")])])])]),t("li",[t("a",{attrs:{href:"#忘记root密码重置root密码"}},[s._v("忘记root密码重置root密码")])]),t("li",[t("a",{attrs:{href:"#卸载mysql操作"}},[s._v("卸载mysql操作")])]),t("li",[t("a",{attrs:{href:"#安装错误异常"}},[s._v("安装错误异常")])]),t("li",[t("a",{attrs:{href:"#mysql8备份还原从数据文件，-backup-restore"}},[s._v("mysql8备份还原从数据文件， backup, restore")])])])]),t("p"),s._v(" "),t("h1",{attrs:{id:"安装步骤如下命令："}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装步骤如下命令："}},[s._v("#")]),s._v(" 安装步骤如下命令：")]),s._v(" "),t("div",{staticClass:"custom-block warning"},[t("p",{staticClass:"custom-block-title"},[s._v("mysql安装密码问题")]),s._v(" "),t("ol",[t("li",[s._v("安装的时候注意选择legecal password,否则wordpress不能访问mysql8数据库")]),s._v(" "),t("li",[s._v("如果是raspberry,则必须安装mariadb")])])]),s._v(" "),t("h2",{attrs:{id:"安装命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装命令"}},[s._v("#")]),s._v(" 安装命令")]),s._v(" "),t("p",[t("strong",[s._v("1. mysql8安装，注意配置大小写安装")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ apt-get install lsb-release\n$ wget https://dev.mysql.com/get/mysql-apt-config_0.8.13-1_all.deb\n$ sudo dpkg -i mysql-apt-config*\n$ sudo apt-get update\n$ sudo apt-get install mysql-server mysql-common\n// 配置数据库表大小写敏感配置\n$ sudo systemctl stop mysql.service\n$ sudo rm -rf /var/lib/mysql\n$ 此处需要执行命令: `sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf`,添加下方的配置: ` lower_case_table_names = 1`\n$ sudo systemctl start mysql.service\n\n")])])]),t("p",[t("strong",[s._v("2. mariadb安装")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo apt update\n$ sudo apt install mariadb-server\n$ sudo systemctl status mariadb\n\n")])])]),t("h2",{attrs:{id:"mysqld-cnf配置参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysqld-cnf配置参数"}},[s._v("#")]),s._v(" mysqld.cnf配置参数")]),s._v(" "),t("p",[t("strong",[s._v("1. mysql配置文件")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf\n")])])]),t("p",[t("strong",[s._v("2. mariadb配置文件")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo /etc/mysql/mariadb.conf.d/50-server.cnf\n\n")])])]),t("p",[t("strong",[s._v("修改以上的配置文件,注意一定要在"),t("code",[s._v("mysqld")]),s._v("区域放入以下的配置信息:")])]),s._v(" "),t("ol",[t("li",[t("code",[s._v("**master**")]),s._v("主数据库写数据<通用配置>:")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("port = 1876\n# 数据表以小写保存，但是比较数据表的时候不区分大小写\nlower_case_table_names=1\ndefault-time-zone='+08:00'\n# The number of seconds that the mysqld server waits for a connect packet before responding with Bad handshake. The default value is 10 seconds.\n# 所有的参数列表： https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html\nconnect_timeout =100\n# 默认 28800，8小时\n#当一个连接的空闲时间超过8小时后，MySQL 就会断开该连接，而 c3p0/dbcp 连接池则以为该被断开的连接依然有效。MySQL server has gone away\nwait_timeout=100\n#默认 28800，8小时\ninteractive_timeout=100\n# MySQL默认的最大连接数为100，MySQL服务器支持允许的最大连接数16384\n#对mysql初始化内存影响这么大\n# 如果设置的太小： 1040-Too many connections，例如当前Max_used_connections=98也会出现这个错误：\n# 所以合理的设置是： Max_used_connections / max_connections * 100% ≈ 85%\n# 参考\nmax_connections=1000\nmax_user_connections=850\n\n# 设置用户密码加密方式\ndefault_authentication_plugin=mysql_native_password\nlog_bin_trust_function_creators=1\n# 配置主从复制\nlog-bin=mysql-bin\nserver-id=1\n# 配置慢查询\nslow_query_log = ON\nslow_query_log_file = /logs/mysql/slow.log\n\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[t("code",[s._v("**slave**")]),s._v("从数据库读数据库(可选):")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("port = 1876\n# 数据表以小写保存，但是比较数据表的时候不区分大小写\nlower_case_table_names=1\ndefault-time-zone='+08:00'\n# The number of seconds that the mysqld server waits for a connect packet before responding with Bad handshake. The default value is 10 seconds.\n# 所有的参数列表： https://dev.mysql.com/doc/refman/8.0/en/server-system-variables.html\nconnect_timeout =100\n# 默认 28800，8小时\n#当一个连接的空闲时间超过8小时后，MySQL 就会断开该连接，而 c3p0/dbcp 连接池则以为该被断开的连接依然有效。MySQL server has gone away\nwait_timeout=100\n#默认 28800，8小时\ninteractive_timeout=100\n# MySQL默认的最大连接数为100，MySQL服务器支持允许的最大连接数16384\n#对mysql初始化内存影响这么大\n# 如果设置的太小： 1040-Too many connections，例如当前Max_used_connections=98也会出现这个错误：\n# 所以合理的设置是： Max_used_connections / max_connections * 100% ≈ 85%\n# 参考\nmax_connections=1000\nmax_user_connections=850\n\n# 设置默认户密码加密方式\ndefault_authentication_plugin=mysql_native_password\nlog_bin_trust_function_creators=1\n# 配置主从复制数据库,为了更好主从复制(io进程和sql进程的操作)低延迟，关闭binlog等\nserver-id=2\nskip-log-bin\n# 1062 Duplicate entry\n# slave-skip-errors=1062,1053,1146 #跳过指定error no类型的错误\nslave-skip-errors=all #跳过所有错误，这个一定要配置，避免不必要的错误导致主从复制失败\n# 配置慢查询\nslow_query_log = 1\nslow_query_log_file = /logs/mysql/slow.log\nlong_query_time = 5\n")])])]),t("h2",{attrs:{id:"配置mysql的用户和密码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置mysql的用户和密码"}},[s._v("#")]),s._v(" 配置mysql的用户和密码")]),s._v(" "),t("p",[s._v("在mysql或者mariadb上运行如下命令进行配置数据库:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1. 初始化配置数据库\n#  sudo mysql_secure_installation\n\n注意： 此处root密码可以随便设置一个，因为下面的第三步会重新设置root密码\n\n-----------------------------------------------\n// 如果不先设置mysql的密码策略登录的时候会包错误: ERROR 1698 (28000): Access denied for user 'root'@'localhost'\n$ mysql -u root -p (直接不输入密码)\n\n2. 查看用户密码设置方式\n> use mysql;\n> SELECT User, Host, plugin FROM mysql.user;\n\n3. 修改root用户密码插件和密码\n> use mysql;\n> UPDATE user SET plugin='mysql_native_password' WHERE User='root';\n> FLUSH PRIVILEGES;\n\n> use mysql;\n> ALTER USER 'root'@'localhost' IDENTIFIED BY 'test1';\n> FLUSH PRIVILEGES;\n\n\n")])])]),t("h2",{attrs:{id:"添加数据库和用户-包括修改用户密码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#添加数据库和用户-包括修改用户密码"}},[s._v("#")]),s._v(" 添加数据库和用户(包括修改用户密码)")]),s._v(" "),t("p",[s._v("logged in mysql using "),t("code",[s._v("root / xxx")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("1. 创建用户\n> create user 'syscorer'@'%' identified by 'testh'; \n> FLUSH PRIVILEGES;\n\n2. 用户权限赋值\nWITH GRANT OPTION 这个选项表示该用户可以将自己拥有的权限授权给别人。注意：经常有人在创建操作用户的时候不指定WITH GRANT OPTION选项导致后来该用户不能使用GRANT命令创建用户或者给其它用户授权。\n如果不想这个用户有这个grant的权限，可以不加这句\n\n> GRANT ALL PRIVILEGES ON *.* TO 'syscorer'@'%'; \n> GRANT ALL PRIVILEGES ON *.* TO 'syscorer'@'%' WITH GRANT OPTION;\n> FLUSH PRIVILEGES;\n\n3. (可选)修改mysql用户密码:\n> alter user 'syscorer'@'%' identified by 'testS';\n> FLUSH PRIVILEGES;\n\n")])])]),t("h2",{attrs:{id:"mysql8数据表大小写敏感（可选-上面第二步已经设置）"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql8数据表大小写敏感（可选-上面第二步已经设置）"}},[s._v("#")]),s._v(" mysql8数据表大小写敏感（可选,上面第二步已经设置）")]),s._v(" "),t("p",[s._v("查看大小写配置，大小写是否敏感:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("show variables where Variable_name='lower_case_table_names';\n\n")])])]),t("p",[s._v("设置"),t("code",[s._v("lower_case_table_names = 1")]),s._v("，以便在数据库中使用不区分大小写的表名。 我编辑了"),t("code",[s._v("/etc/mysql/mysql.conf.d/mysqld.cnf")]),s._v("，并在[mysqld]下添加了上面的配置。收到以下错误:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('Job for mysql.service failed because the control process exited with error code.\nSee "systemctl status mysql.service" and "journalctl -xe" for details.\n')])])]),t("p",[s._v("查看mysql的日志文件: "),t("code",[s._v("tail -f -n 100 /var/log/mysql/error.log")]),s._v(",查看MySQL官方文档，有记录：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("lower_case_table_names can only be configured when initializing the server. Changing the lower_case_table_names setting after the server is initialized is prohibited.\n")])])]),t("p",[s._v("只有在初始化的时候设置 lower_case_table_names=1才有效，比如：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("--initialize --lower-case-table-names=1\n")])])]),t("h2",{attrs:{id:"读写分离配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#读写分离配置"}},[s._v("#")]),s._v(" 读写分离配置")]),s._v(" "),t("ol",[t("li",[s._v("配置读写分离的数据库用户:")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v(" 1.1 master数据库中执行如下命令: \n \n mysql>  CREATE USER 'repdev'@'%' IDENTIFIED WITH mysql_native_password BY 'testh';\n mysql>  GRANT REPLICATION SLAVE ON *.* TO 'repdev'@'%';\n mysql>  flush privileges;\n \n mysql> SHOW MASTER STATUS;\n+------------------+----------+--------------+------------------+-------------------+\n| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |\n+------------------+----------+--------------+------------------+-------------------+\n| mysql-bin.000001 |     2035 |              |                  |                   |\n+------------------+----------+--------------+------------------+-------------------+\n1 row in set (0.00 sec)\n\n\n 1.2 slave节点数据库:   注意MASTER_LOG_FILE和MASTER_LOG_POS是master的正确值,命令如下:\n\nmysql> stop slave;\n\nmysql>  CHANGE MASTER TO\nMASTER_HOST='47.101.187.237',\nMASTER_PORT=1876,\nMASTER_USER='repdev',\nMASTER_PASSWORD='testh',\nMASTER_LOG_FILE='mysql-bin.000009',\nMASTER_LOG_POS=17975043;\n\nmysql> start slave; \nmysql> show slave status\\G;\n\n如果显示的:  Seconds_Behind_Master(主从延时),  Slave_IO_Running=Yes, Slave_SQL_Running=Yes\n\n# 修改对应的slave对应的master的log-bin文件\nMysql> CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000003',MASTER_LOG_POS=342;\n")])])]),t("p",[s._v("说明:  Seconds_Behind_Master参数值\nNULL - 表示io_thread或是sql_thread有任何一个发生故障，也就是该线程的Running状态是No,而非Yes.\n0 - 该值为零，是我们极为渴望看到的情况，表示主从复制良好，可以认为lag不存在。")]),s._v(" "),t("h3",{attrs:{id:"读写分离报错问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#读写分离报错问题"}},[s._v("#")]),s._v(" 读写分离报错问题")]),s._v(" "),t("p",[s._v("1.记录删除失败 "),t("code",[s._v("Could not execute Delete_rows event on table cvr.sys_user; Can't find record in 'sys_user', Error_code: 1032; handler error HA_ERR_KEY_NOT_FOUND; the event's master log mysql-bin.000005, end_log_pos 46653957")]),s._v("错误\n解决方法：master要删除一条记录，而slave上找不到报错，这种情况主都已经删除了，那么从机可以直接跳过指定数量的错误。\n#将同步指针向下移动一个，如果多次不同步可以重复操作：")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("stop slave;set global sql_slave_skip_counter=1;SELECT SLEEP(5);start slave;\n")])])]),t("p",[s._v("If the error is still there, set a bigger value in sql_slave_skip_counter like:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> set global sql_slave_skip_counter=1000;\n")])])]),t("p",[s._v("Again, check the status of the slave.")]),s._v(" "),t("p",[s._v("If you find the skip_sql value is non zero in the slave status then stop the slave again and do:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("mysql> set global sql_slave_skip_counter=0;\nmysql> start slave;\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("主键重复"),t("code",[s._v("Last_SQL_Error: Could not execute Write_rows event on table hcy.t1; Duplicate entry '2' for key 'PRIMARY', Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event's master log mysql-bin.000006, end_log_pos 924")])])]),s._v(" "),t("p",[s._v("在slave已经有该记录，又在master上插入了同一条记录。")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Last_SQL_Error: Could not execute Write_rows event on table hcy.t1; Duplicate entry '2' for key 'PRIMARY', Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event's master log mysql-bin.000006, end_log_pos 924\n\n")])])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("终极解决所有的主从错误同步问题")])]),s._v(" "),t("p",[s._v("直接在"),t("code",[s._v("mysqld.cnf")]),s._v("文件中配置如下忽略所有的错误:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("slave-skip-errors=all\n")])])]),t("h2",{attrs:{id:"忘记root密码重置root密码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#忘记root密码重置root密码"}},[s._v("#")]),s._v(" 忘记root密码重置root密码")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("sudo systemctl  stop mysql\nsudo mysqld_safe --skip-grant-tables --skip-networking &\n# 重启一个命令行窗口执行如下命令\nmysql -u root;\nuse mysql;\nSELECT User, Host, plugin FROM mysql.user;\nupdate user set plugin='mysql_native_password' where user='root';\nflush privileges;\nALTER USER 'root'@'localhost' IDENTIFIED BY 'test2';\nflush privileges;\n")])])]),t("p",[s._v("如果报： "),t("code",[s._v("ERROR 1290 (HY000): The MySQL server is running with the --skip-grant-tables option so it cannot execute this statement")]),s._v(",需要执行一下命令: "),t("code",[s._v("flush privileges")]),s._v(",然后再重新执行命令就好了。")]),s._v(" "),t("h2",{attrs:{id:"卸载mysql操作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#卸载mysql操作"}},[s._v("#")]),s._v(" 卸载mysql操作")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ cd /var/lib/dpkg\n$ sudo mv info info.bak\n$ sudo mkdir info\n$ sudo dpkg --configure -a\n$ sudo apt-get install -f\n$ sudo mv /var/lib/dpkg/info/* /var/lib/dpkg/info.bak\n$ sudo rm -rf /var/lib/dpkg/info\n$ sudo mv /var/lib/dpkg/info.bak /var/lib/dpkg/info\n$ sudo apt remove --purge mysql*\n\n$ sudo apt remove mysql-server\n$ sudo apt purge mysql-server\n$ sudo apt autoremove\n$ sudo find / -name mysql\n\n")])])]),t("h2",{attrs:{id:"安装错误异常"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装错误异常"}},[s._v("#")]),s._v(" 安装错误异常")]),s._v(" "),t("blockquote",[t("p",[s._v("error processing package mysql-community-server (--configure):\ndependency problems - leaving unconfigured")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo apt --yes autoremove --purge mysql-server\n$ sudo apt --yes autoremove --purge mysql-client\n$ sudo rm /var/lib/mysql/ -R\n$ sudo rm /etc/mysql/ -R\n$ sudo apt-get autoremove mysql* --purge\n$ sudo apt-get remove apparmor\n$ sudo apt-get install mysql-server mysql-common\n")])])]),t("h2",{attrs:{id:"mysql8备份还原从数据文件，-backup-restore"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql8备份还原从数据文件，-backup-restore"}},[s._v("#")]),s._v(" mysql8备份还原从数据文件， backup, restore")]),s._v(" "),t("ol",[t("li",[s._v("（"),t("s",[s._v("以下的操作没有成功")]),s._v("）通常mysql的数据库文件目录为: "),t("strong",[s._v("/var/lib/mysql")])])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ sudo systemctl stop mysql\n# 复制数据盘的mysql的数据库文件夹（例如：cvr)到新的mysql数据库目录： /var/lib/mysql\n$ sudo cp -R /opt/mysql/cvr /var/lib/mysql/\n# 配置权限\n$ sudo chown -R mysql:mysql /var/lib/mysql/cvr\n$ sudo chmod -R 660 /var/lib/mysql/cvr\n$ sudo chown  mysql:mysql /var/lib/mysql/cvr \n$ sudo chmod 700 /var/lib/mysql/cvr\n\n$ sudo systemctl restart mysql\n$ sudo mysql -u root -p\n> show databases;\n\n")])])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("采用sql文件进行恢复数据库,注意不同数据库记得切换下")])]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("$ mysql -u root -p cvr < cvr.sql\n")])])])],1)}),[],!1,null,null,null);e.default=n.exports}}]);